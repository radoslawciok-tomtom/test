<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1150px" preserveAspectRatio="none" style="width:1753px;height:1150px;background:#FFFFFF;" version="1.1" viewBox="0 0 1753 1150" width="1753px" zoomAndPan="magnify"><defs><filter height="300%" id="f1nrrt29kjwy7o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="79.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="580.5" y="882.6875"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="887.5234" style="stroke:#000000;stroke-width:2.0;" width="1574.5" x="165" y="173.8281"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="135.6641" style="stroke:#000000;stroke-width:2.0;" width="987" x="175" y="197.9609"/><rect fill="#FFFFFF" height="89.3984" style="stroke:none;stroke-width:1.0;" width="987" x="175" y="244.2266"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="347.625"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="437.0234"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="117.5313" style="stroke:#000000;stroke-width:2.0;" width="804.5" x="541.5" y="497.2891"/><rect fill="#FFFFFF" height="352.1328" style="stroke:none;stroke-width:1.0;" width="1574.5" x="165" y="709.2188"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="620.5" x="541.5" y="902.6875"/><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="77.3984" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="976.9531"/><rect fill="#FFFFFF" height="31.1328" style="stroke:none;stroke-width:1.0;" width="454.5" x="175" y="1023.2188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="34" x2="34" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="298" x2="298" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="585.5" x2="585.5" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="955.5" x2="955.5" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1107" x2="1107" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1249" x2="1249" y1="40.2969" y2="1107.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1393" x2="1393" y1="40.2969" y2="1107.4844"/><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="55" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="12" y="24.9951">Client</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="55" x="5" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="12" y="1126.4795">Client</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="223" x="185" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="209" x="192" y="24.9951">CachingTileServiceDecorator</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="223" x="185" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="209" x="192" y="1126.4795">CachingTileServiceDecorator</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="64" x="551.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="558.5" y="24.9951">stream</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="64" x="551.5" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="558.5" y="1126.4795">stream</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="164" x="871.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="150" x="878.5" y="24.9951">CompressionHandler</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="164" x="871.5" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="150" x="878.5" y="1126.4795">CompressionHandler</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="85" x="1063" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="71" x="1070" y="24.9951">TileCache</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="85" x="1063" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="71" x="1070" y="1126.4795">TileCache</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="170" x="1162" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="156" x="1169" y="24.9951">SatelliteImageService</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="170" x="1162" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="156" x="1169" y="1126.4795">SatelliteImageService</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="91" x="1346" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77" x="1353" y="24.9951">Tileservice</text><rect fill="#FEFECE" filter="url(#f1nrrt29kjwy7o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="91" x="1346" y="1106.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77" x="1353" y="1126.4795">Tileservice</text><rect fill="#FFFFFF" filter="url(#f1nrrt29kjwy7o)" height="79.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="580.5" y="882.6875"/><polygon fill="#A80036" points="286.5,67.4297,296.5,71.4297,286.5,75.4297,290.5,71.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34.5" x2="292.5" y1="71.4297" y2="71.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="41.5" y="66.3638">getTile([tileRequest])</text><polygon fill="#A80036" points="573.5,96.5625,583.5,100.5625,573.5,104.5625,577.5,100.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="298.5" x2="579.5" y1="100.5625" y2="100.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="305.5" y="95.4966">getMetadata([tileRequest])</text><polygon fill="#A80036" points="943.5,125.6953,953.5,129.6953,943.5,133.6953,947.5,129.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="949.5" y1="129.6953" y2="129.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="592.5" y="124.6294">isDefaultQualityLevel(qualityLevel)</text><polygon fill="#A80036" points="596.5,154.8281,586.5,158.8281,596.5,162.8281,592.5,158.8281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="954.5" y1="158.8281" y2="158.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="602.5" y="153.7622">boolean</text><path d="M165,173.8281 L229,173.8281 L229,180.8281 L219,190.8281 L165,190.8281 L165,173.8281 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="887.5234" style="stroke:#000000;stroke-width:2.0;" width="1574.5" x="165" y="173.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="180" y="186.895">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="119" x="244" y="186.0386">[stream not empty]</text><path d="M175,197.9609 L239,197.9609 L239,204.9609 L229,214.9609 L175,214.9609 L175,197.9609 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="135.6641" style="stroke:#000000;stroke-width:2.0;" width="987" x="175" y="197.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="190" y="211.0278">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="248" x="254" y="210.1714">[quality level in [tileRequest] is delault]</text><polygon fill="#A80036" points="309.5,232.2266,299.5,236.2266,309.5,240.2266,305.5,236.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="303.5" x2="584.5" y1="236.2266" y2="236.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="315.5" y="231.1606">[EMPTY]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="175" x2="1162" y1="245.2266" y2="245.2266"/><polygon fill="#A80036" points="1095.5,263.3594,1105.5,267.3594,1095.5,271.3594,1099.5,267.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="1101.5" y1="267.3594" y2="267.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311" x="592.5" y="262.2935">getMetadata(coordinates, format, mapProvider)</text><polygon fill="#A80036" points="596.5,292.4922,586.5,296.4922,596.5,300.4922,592.5,296.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="1106.5" y1="296.4922" y2="296.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="602.5" y="291.4263">[tileMetadata]</text><polygon fill="#A80036" points="309.5,321.625,299.5,325.625,309.5,329.625,305.5,325.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="303.5" x2="584.5" y1="325.625" y2="325.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="315.5" y="320.5591">[tileMetadata]</text><path d="M175,347.625 L239,347.625 L239,354.625 L229,364.625 L175,364.625 L175,347.625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="347.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="190" y="360.6919">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="305" x="254" y="359.8354">[[tileMetadata] not found in cache OR is expired]</text><polygon fill="#A80036" points="309.5,381.8906,299.5,385.8906,309.5,389.8906,305.5,385.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="303.5" x2="584.5" y1="385.8906" y2="385.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="315.5" y="380.8247">[EMPTY]</text><polygon fill="#A80036" points="573.5,418.0234,583.5,422.0234,573.5,426.0234,577.5,422.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="298.5" x2="579.5" y1="422.0234" y2="422.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="305.5" y="416.9575">getCached([tileRequest], [tileMetadata])</text><path d="M175,437.0234 L239,437.0234 L239,444.0234 L229,454.0234 L175,454.0234 L175,437.0234 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="437.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="190" y="450.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="344" x="254" y="449.2339">[ETags from [tileMetadata] and [tileRequest] are equal]</text><polygon fill="#A80036" points="309.5,471.2891,299.5,475.2891,309.5,479.2891,305.5,475.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="303.5" x2="584.5" y1="475.2891" y2="475.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="315.5" y="470.2231">[304 Not Modified]</text><path d="M541.5,497.2891 L605.5,497.2891 L605.5,504.2891 L595.5,514.2891 L541.5,514.2891 L541.5,497.2891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="117.5313" style="stroke:#000000;stroke-width:2.0;" width="804.5" x="541.5" y="497.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="556.5" y="510.356">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="217" x="620.5" y="509.4995">[[tileMetadata] has no [copyright]]</text><polygon fill="#A80036" points="1237,531.5547,1247,535.5547,1237,539.5547,1241,535.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="1243" y1="535.5547" y2="535.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="592.5" y="530.4888">getCopyright(viewPort, ifNoneMatch, language)</text><polygon fill="#A80036" points="596.5,560.6875,586.5,564.6875,596.5,568.6875,592.5,564.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="1248" y1="564.6875" y2="564.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="602.5" y="559.6216">[copyright]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="627.5" y1="593.8203" y2="593.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="627.5" x2="627.5" y1="593.8203" y2="606.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="586.5" x2="627.5" y1="606.8203" y2="606.8203"/><polygon fill="#A80036" points="596.5,602.8203,586.5,606.8203,596.5,610.8203,592.5,606.8203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="291" x="592.5" y="588.7544">merge([tileMetadata], language, [copyright])</text><polygon fill="#A80036" points="1095.5,638.9531,1105.5,642.9531,1095.5,646.9531,1099.5,642.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="1101.5" y1="642.9531" y2="642.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="592.5" y="637.8872">getTile(coordinates, format, String mapProvider)</text><polygon fill="#A80036" points="596.5,668.0859,586.5,672.0859,596.5,676.0859,592.5,672.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="1106.5" y1="672.0859" y2="672.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="602.5" y="667.02">[Tile HTTP response]</text><polygon fill="#A80036" points="309.5,697.2188,299.5,701.2188,309.5,705.2188,305.5,701.2188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="303.5" x2="584.5" y1="701.2188" y2="701.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="315.5" y="696.1528">[Tile HTTP response]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="165" x2="1739.5" y1="710.2188" y2="710.2188"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="256" x="170" y="720.4292">[stream returned [EMPTY] at some point]</text><polygon fill="#A80036" points="573.5,741.1563,583.5,745.1563,573.5,749.1563,577.5,745.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="298.5" x2="579.5" y1="745.1563" y2="745.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="305.5" y="740.0903">getFreshResponse([tileRequest])</text><polygon fill="#A80036" points="1381.5,770.2891,1391.5,774.2891,1381.5,778.2891,1385.5,774.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="1387.5" y1="774.2891" y2="774.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="592.5" y="769.2231">getTile([tileRequest])</text><polygon fill="#A80036" points="596.5,799.4219,586.5,803.4219,596.5,807.4219,592.5,803.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="1392.5" y1="803.4219" y2="803.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="602.5" y="798.356">tileResponse: [Tile HTTP response]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="627.5" y1="832.5547" y2="832.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="627.5" x2="627.5" y1="832.5547" y2="845.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="586.5" x2="627.5" y1="845.5547" y2="845.5547"/><polygon fill="#A80036" points="596.5,841.5547,586.5,845.5547,596.5,849.5547,592.5,845.5547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356" x="592.5" y="827.4888">updateExpireTime([Tile HTTP response], [tileRequest])</text><path d="M960,817.9219 L960,842.9219 L1720,842.9219 L1720,827.9219 L1710,817.9219 L960,817.9219 " fill="#FBFB77" filter="url(#f1nrrt29kjwy7o)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1710,817.9219 L1710,827.9219 L1720,827.9219 L1710,817.9219 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="739" x="966" y="834.9888">If provided expiry time is after configured expiry time, then new expiry time header value is set in http response.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="585.5" x2="632.5" y1="869.6875" y2="869.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="632.5" x2="632.5" y1="869.6875" y2="882.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="591.5" x2="632.5" y1="882.6875" y2="882.6875"/><polygon fill="#A80036" points="601.5,878.6875,591.5,882.6875,601.5,886.6875,597.5,882.6875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="597.5" y="864.6216">cache([tileRequest]), [Tile HTTP response])</text><path d="M541.5,902.6875 L605.5,902.6875 L605.5,909.6875 L595.5,919.6875 L541.5,919.6875 L541.5,902.6875 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="620.5" x="541.5" y="902.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="556.5" y="915.7544">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="248" x="620.5" y="914.8979">[quality level in [tileRequest] is delault]</text><polygon fill="#A80036" points="1095.5,936.9531,1105.5,940.9531,1095.5,944.9531,1099.5,940.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="590.5" x2="1101.5" y1="940.9531" y2="940.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="493" x="597.5" y="935.8872">storeTile(coordinates, format, mapProvider,language, [Tile HTTP response])</text><polygon fill="#A80036" points="596.5,957.9531,586.5,961.9531,596.5,965.9531,592.5,961.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590.5" x2="1106.5" y1="961.9531" y2="961.9531"/><path d="M175,976.9531 L239,976.9531 L239,983.9531 L229,993.9531 L175,993.9531 L175,976.9531 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="77.3984" style="stroke:#000000;stroke-width:2.0;" width="454.5" x="175" y="976.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="190" y="990.02">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="308" x="254" y="989.1636">[[tileRequest].ETag = [Tile HTTP response].ETag]</text><polygon fill="#A80036" points="309.5,1011.2188,299.5,1015.2188,309.5,1019.2188,305.5,1015.2188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="303.5" x2="584.5" y1="1015.2188" y2="1015.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="315.5" y="1010.1528">[304 Not Modified]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="175" x2="629.5" y1="1024.2188" y2="1024.2188"/><polygon fill="#A80036" points="309.5,1042.3516,299.5,1046.3516,309.5,1050.3516,305.5,1046.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="303.5" x2="584.5" y1="1046.3516" y2="1046.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="315.5" y="1041.2856">[Tile HTTP response]</text><polygon fill="#A80036" points="45.5,1085.4844,35.5,1089.4844,45.5,1093.4844,41.5,1089.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="39.5" x2="297.5" y1="1089.4844" y2="1089.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="51.5" y="1084.4185">Mono&lt;ResponseEntity&lt;Resource&gt;&gt;</text><!--MD5=[15cc14893fc9ee1f2ada59dfa10b3960]
@startuml CachingTileServiceDecorator.getTile

!$tileMetadata  = "[tileMetadata]"
!$EMPTY = "[EMPTY]"
!$tileRequest = "[tileRequest]"
!$tileMetadata = "[tileMetadata]"
!$resp_304 = "[304 Not Modified]"
!$copyright = "[copyright]"
!$tile_http_resp = "[Tile HTTP response]"
!$check_def_quality_level = "quality level in [tileRequest] is delault"

Client -> CachingTileServiceDecorator: getTile($tileRequest)
CachingTileServiceDecorator -> stream: getMetadata($tileRequest)
stream -> CompressionHandler: isDefaultQualityLevel(qualityLevel)
CompressionHandler - -> stream: boolean

alt stream not empty

    alt $check_def_quality_level
        stream - -> CachingTileServiceDecorator: $EMPTY
    else
        stream -> TileCache: getMetadata(coordinates, format, mapProvider)
        TileCache - -> stream: $tileMetadata
        stream - -> CachingTileServiceDecorator: $tileMetadata
    end


    alt $tileMetadata not found in cache OR is expired
        stream - -> CachingTileServiceDecorator: $EMPTY
    end

    CachingTileServiceDecorator -> stream: getCached($tileRequest, $tileMetadata)
    
    alt ETags from $tileMetadata and $tileRequest are equal
        stream - -> CachingTileServiceDecorator: $resp_304
    end
    
    alt $tileMetadata has no $copyright
        stream -> SatelliteImageService:  getCopyright(viewPort, ifNoneMatch, language)
        SatelliteImageService - -> stream: $copyright
        stream -> stream: merge($tileMetadata, language, $copyright) 
    end
    
    stream -> TileCache: getTile(coordinates, format, String mapProvider)
    TileCache - -> stream: $tile_http_resp
    stream -> CachingTileServiceDecorator: $tile_http_resp

else stream returned $EMPTY at some point
    CachingTileServiceDecorator -> stream: getFreshResponse($tileRequest)
    stream -> Tileservice: getTile($tileRequest)
    Tileservice - -> stream: tileResponse: $tile_http_resp
    stream -> stream: updateExpireTime($tile_http_resp, $tileRequest)
    note right: If provided expiry time is after configured expiry time, then new expiry time header value is set in http response.
    stream -> stream: cache($tileRequest), $tile_http_resp)
    activate stream
        alt $check_def_quality_level
            stream -> TileCache: storeTile(coordinates, format, mapProvider,language, $tile_http_resp)
        end
        TileCache - -> stream
    deactivate stream
    alt $tileRequest.ETag = $tile_http_resp.ETag
        stream - -> CachingTileServiceDecorator: $resp_304
    else
        stream -> CachingTileServiceDecorator: $tile_http_resp
    end

end

CachingTileServiceDecorator - -> Client: Mono<ResponseEntity<Resource>>

@enduml

@startuml CachingTileServiceDecorator.getTile


Client -> CachingTileServiceDecorator: getTile([tileRequest])
CachingTileServiceDecorator -> stream: getMetadata([tileRequest])
stream -> CompressionHandler: isDefaultQualityLevel(qualityLevel)
CompressionHandler - -> stream: boolean

alt stream not empty

    alt quality level in [tileRequest] is delault
        stream - -> CachingTileServiceDecorator: [EMPTY]
    else
        stream -> TileCache: getMetadata(coordinates, format, mapProvider)
        TileCache - -> stream: [tileMetadata]
        stream - -> CachingTileServiceDecorator: [tileMetadata]
    end


    alt [tileMetadata] not found in cache OR is expired
        stream - -> CachingTileServiceDecorator: [EMPTY]
    end

    CachingTileServiceDecorator -> stream: getCached([tileRequest], [tileMetadata])
    
    alt ETags from [tileMetadata] and [tileRequest] are equal
        stream - -> CachingTileServiceDecorator: [304 Not Modified]
    end
    
    alt [tileMetadata] has no [copyright]
        stream -> SatelliteImageService:  getCopyright(viewPort, ifNoneMatch, language)
        SatelliteImageService - -> stream: [copyright]
        stream -> stream: merge([tileMetadata], language, [copyright]) 
    end
    
    stream -> TileCache: getTile(coordinates, format, String mapProvider)
    TileCache - -> stream: [Tile HTTP response]
    stream -> CachingTileServiceDecorator: [Tile HTTP response]

else stream returned [EMPTY] at some point
    CachingTileServiceDecorator -> stream: getFreshResponse([tileRequest])
    stream -> Tileservice: getTile([tileRequest])
    Tileservice - -> stream: tileResponse: [Tile HTTP response]
    stream -> stream: updateExpireTime([Tile HTTP response], [tileRequest])
    note right: If provided expiry time is after configured expiry time, then new expiry time header value is set in http response.
    stream -> stream: cache([tileRequest]), [Tile HTTP response])
    activate stream
        alt quality level in [tileRequest] is delault
            stream -> TileCache: storeTile(coordinates, format, mapProvider,language, [Tile HTTP response])
        end
        TileCache - -> stream
    deactivate stream
    alt [tileRequest].ETag = [Tile HTTP response].ETag
        stream - -> CachingTileServiceDecorator: [304 Not Modified]
    else
        stream -> CachingTileServiceDecorator: [Tile HTTP response]
    end

end

CachingTileServiceDecorator - -> Client: Mono<ResponseEntity<Resource>>

@enduml

PlantUML version 1.2022.1(Tue Feb 01 19:19:58 CET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>