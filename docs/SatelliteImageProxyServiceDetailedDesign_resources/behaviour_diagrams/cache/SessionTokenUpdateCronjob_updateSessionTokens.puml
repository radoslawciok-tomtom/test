@startuml

!$newKey = "[newKey]"

Client -> SessionTokenUpdateCronjob: updateSessionTokens()

SessionTokenUpdateCronjob -> SecondLevelCache: getSessionKeys()
SecondLevelCache --> SessionTokenUpdateCronjob: list of session keys

loop for every [key] on the list
    alt [key] should be renewed - is close to expiriation date
        SessionTokenUpdateCronjob -> GoogleMapsTileService: createSession(language, format)
        note right: 'close to expiriation' means it will expire in less the 24h
        GoogleMapsTileService --> SessionTokenUpdateCronjob: $newKey
        alt $newKey not null
            SessionTokenUpdateCronjob -> Cache: put(sessionCacheKey, $newKey)
            Cache --> SessionTokenUpdateCronjob
            SessionTokenUpdateCronjob -> SecondLevelCache: put(sessionCacheKey, $newKey)
            SecondLevelCache --> SessionTokenUpdateCronjob
        end
    end
end

SessionTokenUpdateCronjob --> Client

@enduml