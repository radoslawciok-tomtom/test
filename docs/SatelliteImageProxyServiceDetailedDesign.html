<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Satellite Image Proxy Service Detailed Design</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Satellite Image Proxy Service Detailed Design</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_name">Name</a></li>
<li><a href="#_component_type">Component Type</a></li>
<li><a href="#_purpose_and_function">Purpose and function</a></li>
<li><a href="#_requirements">Requirements</a></li>
</ul>
</li>
<li><a href="#_design_assumptions">Design assumptions</a></li>
<li><a href="#_design_decisions">Design decisions</a></li>
<li><a href="#_design">Design</a>
<ul class="sectlevel2">
<li><a href="#_context_dependencies_and_resources">Context dependencies and resources</a></li>
<li><a href="#_interfaces">Interfaces</a></li>
<li><a href="#_design_limitations">Design limitations</a></li>
<li><a href="#_design_overview">Design overview</a></li>
<li><a href="#_behavioral_design">.1. Behavioral Design</a></li>
<li><a href="#_dynamic_behavior">.2. Dynamic Behavior</a></li>
<li><a href="#_non_functional_attributes">.3. Non-functional attributes</a></li>
<li><a href="#_error_handling">.4. Error handling</a></li>
</ul>
</li>
<li><a href="#_verification_and_validation">1. Verification and validation</a>
<ul class="sectlevel2">
<li><a href="#_unit_tests">1.1. Unit tests</a></li>
<li><a href="#_integration_and_qualification_tests_xray">1.2. Integration and qualification tests (Xray)</a></li>
<li><a href="#_running_automated_tests">1.3. Running automated tests</a></li>
</ul>
</li>
<li><a href="#_terminology_and_abbreviations">2. Terminology and abbreviations</a></li>
<li><a href="#_references">3. References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>Authors and Contributors</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jijucyriacmanjooran-tomtom">Jiju Cyriac Manjooran</a></p>
</li>
<li>
<p><a href="https://github.com/radoslawciok-tomtom">Radoslaw Ciok</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Document history</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">Date</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Change</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17 Nov 2020</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jijucyriacmanjooran-tomtom">Jiju Cyriac Manjooran</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document released</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25 Jan 2021</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adaptation to <a href="https://confluence.tomtomgroup.com/display/HCP3/Detailed+Design+review+guidelines">Detailed Design review guidelines</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25 Feb 2021</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jijucyriacmanjooran-tomtom">Jiju Cyriac Manjooran</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resilience to communication failures with cosmosdb</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Review status</strong></p>
</div>
<div class="paragraph">
<p>Review status</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Reviewer</th>
<th class="tableblock halign-left valign-top">Approved</th>
<th class="tableblock halign-left valign-top">Needs work</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://confluence.tomtomgroup.com/display/~fyukova">Alexander Fyukov</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#10003;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://confluence.tomtomgroup.com/display/~klecha">Marcin Klecha</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#10003;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://confluence.tomtomgroup.com/display/~lheres">Louwe Heres</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#10003;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://confluence.tomtomgroup.com/display/~manjoora">Jiju Cyriac Manjooran</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#10003;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_name">Name</h3>
<div class="paragraph">
<p>Satellite Image Proxy</p>
</div>
</div>
<div class="sect2">
<h3 id="_component_type">Component Type</h3>
<div class="paragraph">
<p>Java web application / rest service.</p>
</div>
</div>
<div class="sect2">
<h3 id="_purpose_and_function">Purpose and function</h3>
<div class="paragraph">
<p>Provide satellite map images and copyright information about them via REST API.</p>
</div>
<div class="paragraph">
<p>Retrieve satellite images from Google (or other map provider), compress and cache them in order to:</p>
</div>
<div class="paragraph">
<p>save on bandwidth by stronger compression
improve the responsiveness and save on Google API usage by caching and reusing the compressed image tiles over multiple vehicles</p>
</div>
</div>
<div class="sect2">
<h3 id="_requirements">Requirements</h3>
<div class="paragraph">
<p>SIP has to:</p>
</div>
<div class="paragraph">
<p>support different map providers based on region
support caching the Google sessions
support caching the tile images
support compression (jpeg, astc, etc.)
support mocking google tile api for unit testing bad weather scenarios</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_assumptions">Design assumptions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Google API key is valid indefinitely and won&#8217;t change on regular basis</p>
</li>
<li>
<p>tile images and copyright information can be cached in service for the period returned in "Cache-Control" headers</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_decisions">Design decisions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section can be found in <a href="https://confluence.tomtomgroup.com/x/XMRKN">Confluence</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design">Design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document considers Satellite Image Proxy (SIP) service as software component and java classes as software unit.</p>
</div>
<div class="sect2">
<h3 id="_context_dependencies_and_resources">Context dependencies and resources</h3>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/sip-context.drawio.svg" alt="sip context.drawio"></span><br>
<em>High level software components design</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_interfaces">Interfaces</h3>
<div class="paragraph">
<p>Only interface exposed by the service is the REST API, see <a href="https://confluence.tomtomgroup.com/x/5aFKN">Satellite Image Proxy Service - API Specification</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_design_limitations">Design limitations</h3>
<div class="paragraph">
<p>Currently, SIP is a single java application. As a future improvement SIP will be decomposed to smaller components, which will run independently deployed from each other and communicate over http protocol. SIP will be divided to components with respect to responsibilities of each component. This improvement is planned to improve overall service performance. Now different SIP modules have very different memory and CPU usage.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/SIP_decomposition.svg" alt="SIP decomposition"></span></p>
</div>
<div class="paragraph">
<p><em>SIP decomposition to smaller components</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_design_overview">Design overview</h3>
<div class="sect3">
<h4 id="_component_level_design">Component level design</h4>
<div class="paragraph">
<p>This diagram shows how SIP component communicates with external services and resources.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/SIP-container-diagram.drawio.svg" alt="SIP container diagram.drawio"></span><br>
<em>Component level design</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_conceptual_design">Conceptual design</h4>
<div class="paragraph">
<p>This diagram shows conceptual division of SIP application into modules.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/sip-resilience-component-diagram.drawio.svg" alt="sip resilience component diagram.drawio"></span><br>
<em>SIP Conceptual design</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_flow_design">Flow design</h4>
<div class="paragraph">
<p>This section presents detail flow design of most important SIP functionalities.</p>
</div>
<div class="sect4">
<h5 id="_sip_request_flow">SIP request flow</h5>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/sip-image-request-flow.drawio.svg" alt="sip image request flow.drawio"></span><br>
<em>Overall SIP requests flow diagram.</em></p>
</div>
<div class="paragraph">
<p>Following decisions where made during design:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>automatic expiration of records in Redis is based on Cache-Control header of Google&#8217;s response</p>
<div class="ulist">
<ul>
<li>
<p>Redis size is crucial factor for cost of the solution, we should not keep records (especially images which take up much more space) longer than they are useful</p>
</li>
</ul>
</div>
</li>
<li>
<p>asynchronous saving images and metadata to cache</p>
<div class="ulist">
<ul>
<li>
<p>we want to serve client with image as fast as possible, therefore we can store images and metadata in background thread</p>
</li>
</ul>
</div>
</li>
<li>
<p>no synchronization of image fetching</p>
<div class="ulist">
<ul>
<li>
<p>there might be situation when there are two request for the same tile (same x, y, zoom parameters) and that tile is not available in cache (either never downloaded or expired)</p>
</li>
<li>
<p>we allow both requests to download the file on their own and race to save data in Redis</p>
</li>
<li>
<p>adding synchronization (i.e. assuring only one request at a time is downloading particular map tile) would increase complexity of the solution, add extra latency (locking, polling) and might severely impact service performance in case of thread/instance failure before unlocking the resource</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="google-session-management">Google session management</h5>
<div class="paragraph">
<p>SIP uses google session tokens to get data from google api. Any request for tails or copyrights requires providing valid session token to get data.
Session tokens from google are valid for 15 days, but SIP renew them 1 day before to be sure that application will not try to request google data with invalid token.</p>
</div>
<div class="paragraph">
<p>SIP uses 2 levels of cache to store tokens:
* 1&#8217;st level - internal application instance cache - first place to lookup for valid token
* 2&#8217;nd level - Redis - deployed as Azure service, shared by all application instances.
Get google token for requesting data for Google.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/SipCacheDiagram.drawio.svg" alt="SipCacheDiagram.drawio"></span><br>
<em>Google session management flow</em></p>
</div>
<div class="paragraph">
<p>Chosen job updating tokens cl to expiration date.
Sip has cron job running every day.
It is checking how long google session tokens stored in 2&#8217;nd level cache will still be valid.
If some token will expire in less than 24 hours, then it is re-new and updated in 1&#8217;st and 2&#8217;nd level cache.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/CronJobDiagram.drawio.svg" alt="CronJobDiagram.drawio"></span><br>
<em>Google sessions cache update flow</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_resilience">Resilience</h5>
<div class="paragraph">
<p>SIP uses Resilience4j library to control requests load to external services - Redis, Google. Load to those services is driven by errors. When error is thrown during communication to these services, request sending is stopped for given time.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/sip-components-diagram.drawio.svg" alt="sip components diagram.drawio"></span><br>
<em>Resiliency in SIP service</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Time limiter will prevent Redis requests from taking too long (&gt;500ms) in case of communication failures.</p>
</li>
<li>
<p>Circuit breaker will prevent too many background requests choking sip in case of communication failures</p>
<div class="ulist">
<ul>
<li>
<p>Circuit breaker goes into OPEN state if 5 out of last 10 requests fail</p>
</li>
<li>
<p>Circuit breaker remains in OPEN state for 30 secs (no more requests to Redis are allowed)</p>
</li>
<li>
<p>After 30 secs, one request to Redis is allowed which will determine whether to switch to CLOSED or remain OPEN</p>
</li>
</ul>
</div>
</li>
<li>
<p>If request times out or if Circuit breaker is OPEN, then SIP will serve images from google.</p>
</li>
<li>
<p>the liveness endpoint includes the state of the circuit breaker (ie, liveness=DOWN when Circuit breaker=OPEN)</p>
</li>
<li>
<p>Kubernetes will restart the node if liveness is DOWN for 90 secs</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_max_zoom_header_in_tile_not_found_responses">Max Zoom Header in Tile Not-Found Responses</h5>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/DesignSIP_resources/sip-tilenotfound-with-maxzoomheader.svg" alt="sip tilenotfound with maxzoomheader"></span><br>
<em>Max Zoom Header in Tile Not-Found Responses</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>MaxZoomRects : Google viewport response includes a list of rectangles with max zoom for each. This information is less accurate (always &gt;= 19) but can be prefetched.</p>
</li>
<li>
<p>NoTileAreas: Tiles are missing even at Google suggested max zoom levels and lower. We can know of them only when we try to get tiles in those areas. This information is very accurate but can only be built over time.</p>
</li>
<li>
<p>In case of tile-not-found for zoom beyond google-suggested-zoom, we respond with 404 + maxZoom based on MaxZoomRects.</p>
</li>
<li>
<p>In case of tile-not-found for zoom within google-suggested-zoom and tile is still missing, then</p>
<div class="ulist">
<ul>
<li>
<p>for first request we return just 404, and asynchronously find/save NoTileArea.</p>
</li>
<li>
<p>for subsequent requests (for even any coordinates within the same No-Tile-Area), we respond with 404 + accurate maxZoom based on NoTileAreas.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_detailed_structural_design">Detailed structural design</h4>
<div class="paragraph">
<p>This document will consider  java classes as software units. Below diagram present structure of main classes which application is composed of.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/SatelliteImageProxyImpl_structure.svg" alt="SatelliteImageProxyImpl structure"></span><br></p>
</div>
<div class="paragraph">
<p><em>Structural diagram of main Sip classes</em></p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.<strong>SatelliteImageProxyImpl</strong> -
Main class which is input of application. Methods of the class handles rest endpoint requests.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.inmemory.<strong>InMemorySecondLevelCache</strong> -
Data access class for Google session stored in in-memory cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.redis.<strong>SecondLevelCacheImpl</strong> -
Data access class for Google session stored in external application cache. Wrapper for session access repository.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.redis.<strong>RedisSessionRepository</strong> -
Data access class for Google session stored in external application cache. Class access data directly from cache.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.utils.<strong>TileCoordinatesUtils</strong> -
Helper class for operation made on tile coordinates</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.inmemory.<strong>InMemoryTileImageRepository</strong> -
Data access class for tiles stored in in-memory cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.inmemory.<strong>InMemoryTileMetadataRepository</strong> -
Data access class for metadata stored in in-memory cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.redis.<strong>RedisTileImageRepository</strong> -
Data access class for tiles stored in external cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.redis.<strong>RedisTileMetadataRepository</strong> -
Data access class for metadata stored in external cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.service.impl.<strong>DefaultNoTileAreaService</strong> -
Class contains logic related with no tile areas</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.redis.<strong>RedisNoTileAreaRepository</strong> -
Data access class for no tile area stored in external cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.monitoring.<strong>TracingIdFilter</strong> -
Filter for enhance response with traceId for logging purposes</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.utils.<strong>ExceptionUtils</strong> -
Exception helper class.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.model.<strong>CacheControlDetails</strong> -
Class encapsulates metadata related to cache entries.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.model.<strong>NoTileAreaCoordinates</strong> -
Model class containing coordinates on not tile area.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.inmemory.<strong>InMemoryNoTileAreaRepository</strong> -
Data access class for no tile area stored in in-memory cache</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.service.impl.<strong>DefaultGoogleMapsTileService</strong> -
Logic for getting data from google rest service.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.exception.<strong>RestExceptionHandler</strong> -
Global handler for application exceptions.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.service.impl.<strong>DefaultMaxZoomService</strong> -
Service for calculating max available zoom for a tile.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.service.impl.<strong>CachingSessionContextProvider</strong> -
Create google session context for request sending to google api.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.cache.cronjobs.<strong>SessionTokenUpdateCronjob</strong> -
Cronjob class executing scheduled tasks periodically.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.google.service.impl.<strong>GoogleSatelliteImageService</strong> -
Provides methods to retrieve satellite image tiles.</p>
</div>
<div class="paragraph">
<p>Com.tomtom.puas.sip.components.compression.impl.<strong>JpegCompressionService</strong> - responsible for compression tile images.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_behavioral_design">.1. Behavioral Design</h3>
<div class="paragraph">
<p>This document will consider Satellite Image Proxy as the software
component and java classes as software units.</p>
</div>
<div class="sect3">
<h4 id="_unit_interfaces">.1.1. Unit interfaces</h4>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_satelliteimageproxyimpl">com.tomtom.puas.sip.SatelliteImageProxyImpl</h5>
<div class="paragraph">
<p>Main class which is input of application. Methods of the class handles rest endpoint requests.</p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettilestring_version_integer_zoom_integer_x_integer_y_string_ifnonematch_string_format_string_region_integer_qualitylevel_string_language_serverwebexchange_exchange">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(String version, Integer zoom, Integer x, Integer y, String ifNoneMatch, String format, String region, Integer qualityLevel, String language, ServerWebExchange exchange)</h5>
<div class="paragraph">
<p>Implementation for rest endpoint: GET /sip/{version}/tile/{z}/{x}/{y}
Get a satellite image tile specified by zoom level, x and y coordinates. Retrieving tile is delegated to class implementing <em>TileService</em> interface.
Method proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verifies <em>version</em> parameter against current api version. Throws <em>VersionNotSupportedException</em> if they don&#8217;t match.</p>
</li>
<li>
<p>Verifies requested tile image format. Throws <em>FormatNotSupportedException</em> if format is not supported. Currently, only supported format is <em>jpeg</em>.</p>
</li>
<li>
<p>Delegates tile image retrieval to <em>TileService</em> implementation class and returns result without changes.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/sip/SatelliteImageProxyImpl_getTile.svg" alt="SatelliteImageProxyImpl getTile">
</div>
</div>
<div class="paragraph">
<p><em>SatelliteImageProxyImpl.getTile</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>version (String) - The version of the service to call. (required)</p>
</li>
<li>
<p>z (Integer) - Zoom level of the tile to be rendered. (required)</p>
</li>
<li>
<p>x (Integer) - The x coordinate of the tile on a zoom grid. Values 0..2^(z-1). (required)</p>
</li>
<li>
<p>y (Integer) - The y coordinate of the tile on a zoom grid. Values 0..2^(z-1). (required)</p>
</li>
<li>
<p>ifNoneMatch (String) - Contains an identifier for a specific version of resource. The server will send back the requested resource, with a 200 HTTP status code, only if it doesn&#39;t have an ETag matching the given one. Otherwise, a 304 HTTP status code will be returned to indicate that content is not changed. (optional)</p>
</li>
<li>
<p>format (String) - The format of the Response. (optional, default to jpeg)</p>
</li>
<li>
<p>region (String) - A CLDR region identifier representing the physical location of the user. e.g. KR for South Korea. This parameter will be used to choose the appropriate backend content provider. If this parameter is not specified or is invalid, the default backend content provider will be used. (optional)</p>
</li>
<li>
<p>qualityLevel (Integer) - A percentage value indicating the desired quality of image. Lower the quality-level, the more compressed the image. A factor of 100 will return the original image without any compression by SIP. Compression by SIP may be limited by the quality of the original image. for example jpeg images from Google are already at 90-95% jpeg-quality and compressing it again using same or bigger quality-level will not result in any compression. (optional)</p>
</li>
<li>
<p>language (Integer) - A CLDR language identifier indicating the language information. For example, en-US or ja-JP. (optional, default to 'en-US')</p>
</li>
<li>
<p>exchange (ServerWebExchange) - injected by framework</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Return</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Http response with tile image resource. Status code and headers are set by <em>TileService</em> and returned unchanged to client.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>VersionNotSupportedException</em> if version provided in request doesn&#8217;t match current api version.</p>
</li>
<li>
<p><em>FormatNotSupportedException</em> if requested tile format is not supported. Currently, only supported format is <em>jpeg</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[Req-SIP-10]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentitycopyright_getcopyrightstring_version_float_north_float_south_float_east_float_west_integer_zoom_string_ifnonematch_string_language_string_region_serverwebexchange_exchange">Mono&lt;ResponseEntity&lt;Copyright&gt;&gt; getCopyright(String version, Float north, Float south, Float east, Float west, Integer zoom, String ifNoneMatch, String language, String region, ServerWebExchange exchange)</h5>
<div class="paragraph">
<p>Implementation for rest endpoint: GET /sip/{version}/copyright/
Get copyright text for the specified area.
Method proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verifies <em>version</em> parameter against current api version. Throws <em>VersionNotSupportedException</em> if they don&#8217;t match.</p>
</li>
<li>
<p>Delegates copyright retrieval to <em>CopyrightService</em> result without changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>version (String) - The version of the service to call. (required).</p>
</li>
<li>
<p>north (Float) - The furthest north point in the viewport expressed in degrees. North must be in the range (-90,90). (required)</p>
</li>
<li>
<p>south (Float) - The furthest south point in the viewport expressed in degrees. South must be in the range (-90,90). (required)</p>
</li>
<li>
<p>east (Float) - The furthest east point in the viewport expressed in degrees. East must be in the range (-180,180). (required)</p>
</li>
<li>
<p>west (Float) - The furthest west point in the viewport expressed in degrees. West must be in the range (-180,180). (required)</p>
</li>
<li>
<p>zoom (Integer) - This is the current zoom level of the viewport. (required)</p>
</li>
<li>
<p>ifNoneMatch (String) - Contains an identifier for a specific version of resource. The server will send back the requested resource, with a 200 HTTP status code, only if it doesn&#8217;t have an ETag matching the given one. Otherwise, a 304 HTTP status code will be returned to indicate that content is not changed. (optional)</p>
</li>
<li>
<p>language (String) - A CLDR language identifier indicating the language information. For example, en-US or ja-JP. (optional, default to 'en-US')</p>
</li>
<li>
<p>region (String) - A CLDR region identifier representing the physical location of the user. e.g. KR for South Korea. This parameter will be used to choose the appropriate backend content provider. If this parameter is not specified or is invalid, the default backend content provider will be used. (optional)</p>
</li>
<li>
<p>exchange (ServerWebExchange) - injected by framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Copyright&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Return the copyright text for the specified area. Status code and headers are set by <em>CopyrightService</em> and returned unchanged to client.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>VersionNotSupportedException</em> if "version" parameter doesn&#8217;t match currently called api.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-11]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentitymetadata_getmetadatastring_version_string_region_serverwebexchange_exchange">Mono&lt;ResponseEntity&lt;Metadata&gt;&gt; getMetadata(String version, String region, ServerWebExchange exchange)</h5>
<div class="paragraph">
<p>Implementation for rest endpoint: GET /sip/{version}/metadata
Get metadata info by given map provider in the requested region.
Method proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verifies <em>version</em> parameter against current api version. Throws <em>VersionNotSupportedException</em> if they don&#8217;t match.</p>
</li>
<li>
<p>Delegates copyright retrieval to <em>MetadataService</em> result without changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>version (String) The version of the service to call. (required)</p>
</li>
<li>
<p>region (String) A CLDR region identifier representing the physical location of the user. e.g. KR for South Korea. This parameter will be used to choose the appropriate backend content provider. If this parameter is not specified or is invalid, the default backend content provider will be used. (optional)</p>
</li>
<li>
<p>exchange (ServerWebExchange) - injected by framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Metadata&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Returns metadata info for the given parameters. Status code and headers are set by <em>MetadataService</em> and returned unchanged to client.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong>
<em>VersionNotSupportedException</em> if "version" parameter doesn&#8217;t match currently called api.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-12]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_service_basictileservice">com.tomtom.puas.sip.service.BasicTileService</h5>

</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettiletilerequest_tilerequest">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(TileRequest tileRequest)</h5>
<div class="paragraph">
<p>Responsible for retrieving tile image and copyright from external service (Google) and send data back to client. Uses <em>GoogleSatelliteImageService</em> to get tiles from google service.
If <em>GoogleSatelliteImageService</em> returns <em>Mono&lt;SipException&gt;</em>, then this method will throw <em>SipException</em> as well.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/service/BasicTileService_getTile.svg" alt="BasicTileService getTile">
</div>
</div>
<div class="paragraph">
<p><em>BasicTileService.getTile</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>TileRequest - object containing all information needed to make request to google for tiles: coordinates, eTag, format, qualityLevel, mapProvider, language.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p><em>ResponseEntity</em> containing tile image data as a spring <em>Resource</em>. <em>ResponseEntity</em> object is created by <em>GoogleSatelliteImageService</em> and return to the client in unchanged with regard to http response body, header and status.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>SipException</em> if <em>GoogleSatelliteImageService</em> returns <em>Mono&lt;SipException&gt;</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-1]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_service_cachingtileservicedecorator">com.tomtom.puas.sip.service.CachingTileServiceDecorator</h5>

</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettiletilerequest_tilerequest_2">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(TileRequest tileRequest)</h5>
<div class="paragraph">
<p>Responsible for retrieving tile image and copyright from cache or external service (google), and then add it to cache if not present.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/service/CachingTileServiceDecorator_getTile.svg" alt="CachingTileServiceDecorator getTile">
</div>
</div>
<div class="paragraph">
<p><em>CachingTileServiceDecorator.getTile</em></p>
</div>
<div class="paragraph">
<p>Expiry time of a tile is stored in cache in tile metadata and returned to client as a http response header. Expiry time of a new tile (not in cache yet) is calculated
from google api response base in fields:
1. <em>max-age</em> - currentTime + <em>max-age</em>.
2. if <em>max-age</em> not present, then uses <em>Expiry</em> field.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>TileRequest - object containing all information needed to make request to google for tiles: coordinates, eTag, format, qualityLevel, mapProvider, language.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p><em>ResponseEntity</em> containing tile image data as a spring <em>Resource</em>.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>SipException</em> if <em>GoogleSatelliteImageService</em> returns <em>Mono&lt;SipException&gt;</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-2]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_service_copyrightheaderencodingtileservicedecorator">com.tomtom.puas.sip.service.CopyrightHeaderEncodingTileServiceDecorator</h5>

</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettiletilerequest_tilerequest_3">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(TileRequest tileRequest)</h5>
<div class="paragraph">
<p>Responsible for retrieving tile image and copyright from cache or external service (google).
If <em>TileService</em> returns data, then encode copyright headers before sending back to service client. Otherwise, method returns unchanged response from <em>TileService</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/service/CopyrightHeaderEncodingTileServiceDecorator_getTile.svg" alt="CopyrightHeaderEncodingTileServiceDecorator getTile">
</div>
</div>
<div class="paragraph">
<p><em>CopyrightHeaderEncodingTileServiceDecorator.getTile</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>TileRequest - object containing all information needed to make request to google for tiles: coordinates, eTag, format, qualityLevel, mapProvider, language.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Copyright data.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-9]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_compression_compressionhandler">com.tomtom.puas.sip.components.compression.CompressionHandler</h5>

</div>
<div class="sect4">
<h5 id="_resource_compressstring_format_integer_qualitylevel_resource_resourcecompressionhandler">Resource compress(String format, Integer qualityLevel, Resource resource)CompressionHandler</h5>
<div class="paragraph">
<p>Compresses image resource with given quality level and format.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/compression/CompressionHandler_compress.svg" alt="CompressionHandler compress">
</div>
</div>
<div class="paragraph">
<p><em>CompressionHandler.compress</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>format - image format.</p>
</li>
<li>
<p>qualityLevel - quality level of image in resource.</p>
</li>
<li>
<p>resource - image resource to compress.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Resource)</p>
</div>
<div class="paragraph">
<p>Compressed resource image. null if input resource was null;</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-3]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_boolean_isdefaultqualitylevelinteger_qualitylevel">boolean isDefaultQualityLevel(Integer qualityLevel)</h5>
<div class="paragraph">
<p>Checks if quality level has default value.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>qualityLevel: int - Quality level of compression</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (boolean)</p>
</div>
<div class="paragraph">
<p>'True' if 'qualityLevel' is null or is equal to default value, otherwise returns 'False'.
Default quality level is set in application configuration.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-4]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_tilecache">com.tomtom.puas.sip.components.cache.TileCache</h5>

</div>
<div class="sect4">
<h5 id="_monotilemetadata_getmetadatatilecoordinates_coordinates_string_format_string_mapprovider">Mono&lt;TileMetadata&gt; getMetadata(TileCoordinates coordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves tile metadata from application cache by delegating 'get' operation to <em>TileMetadataRepository</em> instance.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - Coordinates of a tile for which metadata was stored. Is a part of cache key string.</p>
</li>
<li>
<p>format (String) - Format of a cached image. Is a part of cache key string.</p>
</li>
<li>
<p>mapProvider (String) - name of external service providing map images (e.g.: google). Is a part of cache key string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;TileMetadata&gt;)</p>
</div>
<div class="paragraph">
<p>TileMetadata object retrieved by repository. Response is wrapped in Reactor <em>Mono</em> object for further stream processing.
Returns empty <em>Mono</em> if no data was found by <em>TileMetadataRepository</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-5]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresource_gettiletilecoordinates_coordinates_string_format_string_mapprovider">Mono&lt;Resource&gt; getTile(TileCoordinates coordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves tile from application cache by delegating 'get' operation to <em>TileImageRepository</em> instance.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - Coordinates of a tile. Is a part of cache key string.</p>
</li>
<li>
<p>format (String) - Format of a cached image. Is a part of cache key string.</p>
</li>
<li>
<p>mapProvider (String) - name of external service providing map images (e.g.: google). Is a part of cache key string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Resource&gt;)</p>
</div>
<div class="paragraph">
<p>Spring <em>Resource</em> object with cached tile image. Response is wrapped in Reactor <em>Mono</em> object for further stream processing.
Returns empty <em>Mono</em> if no data was found by <em>TileMetadataRepository</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-6]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_storetiletilecoordinates_coordinates_string_format_string_mapproviderstring_language_responseentityresource_response">Mono&lt;Void&gt; storeTile(TileCoordinates coordinates, String format, String mapProvider,String language, ResponseEntity&lt;Resource&gt; response)</h5>
<div class="paragraph">
<p>Store tiles and metadata for a tile in cache by delegating 'store' operation to <em>TileMetadataRepository</em> and <em>TileImageRepository</em>.
If storing metadata fails with exception then it will not store the tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - Coordinates of a tile for which metadata was stored. Is a part of cache key string.</p>
</li>
<li>
<p>format (String) - Format of a cached image. Is a part of cache key string.</p>
</li>
<li>
<p>mapProvider (String) - name of external service providing map images (e.g.: google). Is a part of cache key string.</p>
</li>
<li>
<p>language (String) - tile language.</p>
</li>
<li>
<p>response (ResponseEntity&lt;Resource&gt;) - object represents http response. It contains tile resource in body and copyrights in headers to be cached.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Viod&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em> object.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>RuntimeException</em> if <em>TileMetadataRepository</em> or <em>TileImageRepository</em> throw exception when storing data.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-7]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_updatemetadatatilemetadata_tilemetadata">Mono&lt;Void&gt; updateMetadata(TileMetadata tileMetadata)</h5>
<div class="paragraph">
<p>Updates existing metadata in cache by delegating 'put' operation to <em>TileMetadataRepository</em> instance.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileMetadata (TileMetadata) - metadata object to update in cache. by delegating to cache repositories injected to TileCache instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Viod&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em> object.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-8]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_inmemory_inmemorysecondlevelcache">com.tomtom.puas.sip.components.cache.inmemory.InMemorySecondLevelCache</h5>
<div class="paragraph">
<p>Class is a responsible for managing communication with in-memory application cache.</p>
</div>
</div>
<div class="sect4">
<h5 id="_monosession_putsessioncachekey_sessioncachekey_session_session">Mono&lt;Session&gt; put(SessionCacheKey sessionCacheKey, Session session)</h5>
<div class="paragraph">
<p>Stores google session token in in-memory application cache.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache.</p>
</li>
<li>
<p>session (Session) - Session object to store in cache. Object wraps google token string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Stored session object.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-13]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monosession_getsessioncachekey_sessioncachekey">Mono&lt;Session&gt; get(SessionCacheKey sessionCacheKey)</h5>
<div class="paragraph">
<p>Retrieves google session token object from in-memory cache.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache to retrieve.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Retrieved session object wrapped in <em>Mono</em>. If no session was found under given key returns empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-14]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_redis_secondlevelcacheimpl">com.tomtom.puas.sip.components.cache.redis.SecondLevelCacheImpl</h5>

</div>
<div class="sect4">
<h5 id="_monosession_putsessioncachekey_sessioncachekey_session_session_2">Mono&lt;Session&gt; put(SessionCacheKey sessionCacheKey, Session session)</h5>
<div class="paragraph">
<p>Stores google session token in 2nd level cache. Operation is delegated to <em>RedisSessionRepository</em>.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache.</p>
</li>
<li>
<p>session (Session) - Session object to store in cache. Object wraps token string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Session object returned by <em>RedisSessionRepository.put</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-16]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monosession_getsessioncachekey_sessioncachekey_2">Mono&lt;Session&gt; get(SessionCacheKey sessionCacheKey)</h5>
<div class="paragraph">
<p>Retrieves session object from 2nd level cache. Operation is delegated to <em>RedisSessionRepository</em>.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache to retrieve.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Retrieved session object wrapped in <em>Mono</em>. If no session was found under given key then returns empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-17]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_fluxtuple2string_session_getsessionkeys">Flux&lt;Tuple2&lt;String, Session&gt;&gt; getSessionKeys()</h5>
<div class="paragraph">
<p>Retrieves all session objects stored in 2nd level application cache with their cache keys. Operation is delegated to <em>RedisSessionRepository</em>.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Flux&lt;Tuple2&lt;String, Session&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>All session objects stored in 2nd level application cache.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-18]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_redis_redissessionrepository">com.tomtom.puas.sip.components.cache.redis.RedisSessionRepository</h5>

</div>
<div class="sect4">
<h5 id="_monosession_putsessioncachekey_sessioncachekey_session_session_3">Mono&lt;Session&gt; put(SessionCacheKey sessionCacheKey, Session session)</h5>
<div class="paragraph">
<p>Stores or updates google session object in 2nd level cache under given key.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache.</p>
</li>
<li>
<p>session (Session) - Session object to store in cache. Object wraps token string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Stored session object.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-19]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monosession_getsessioncachekey_sessioncachekey_3">Mono&lt;Session&gt; get(SessionCacheKey sessionCacheKey)</h5>
<div class="paragraph">
<p>Retrieves session object from 2nd level cache.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>sessionCacheKey (SessionCacheKey) - Cache key which identifies record in cache to retrieve.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Session&gt;)</p>
</div>
<div class="paragraph">
<p>Retrieved session object wrapped in <em>Mono</em> or empty <em>Mono</em> if no session was found under given key.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-20]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_fluxtuple2string_session_getsessionkeys_2">Flux&lt;Tuple2&lt;String, Session&gt;&gt; getSessionKeys()</h5>
<div class="paragraph">
<p>Retrieves all session objects stored in 2nd level application cache with their cache keys.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Flux&lt;Tuple2&lt;String, Session&gt;&gt;)
Gets all session objects stored in 2nd level application cache with their cache keys.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-21]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_utils_tilecoordinatesutils">com.tomtom.puas.sip.components.google.utils.TileCoordinatesUtils</h5>

</div>
<div class="sect4">
<h5 id="_static_point_centralpointtilecoordinates_tilecoordinates">static Point centralPoint(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Calculates geographical coordinates (latitude and longitude) for central point in tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates - <em>TileCoordinates</em> object representing tile to transform.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Point)</p>
</div>
<div class="paragraph">
<p><em>Point</em> representing coordinates of central point.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-23]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_public_static_boolean_outofrangetilecoordinates_tilecoordinates">public static boolean outOfRange(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Checks if x or y coordinates are within range possible for given zoom.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates - <em>TileCoordinates</em> object representing tile to verify.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (boolean)</p>
</div>
<div class="paragraph">
<p>'true' if x, y coordinates are within the range, 'false' otherwise.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-70]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_double_southtilecoordinates_tilecoordinates">static Double south(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Calculates latitude for south edge of given tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of tile in degrees.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Double)</p>
</div>
<div class="paragraph">
<p>Latitude value of south edge of given tile.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-24]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_double_northtilecoordinates_tilecoordinates">static Double north(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Calculates latitude for north edge of given tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of tile in degrees.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Double)</p>
</div>
<div class="paragraph">
<p>Latitude value of north edge of given tile.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-25]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_double_easttilecoordinates_tilecoordinates">static Double east(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Calculates longitude for east edge of given tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of tile in degrees.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Double)</p>
</div>
<div class="paragraph">
<p>Longitude value of east edge of given tile.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-26]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_double_westtilecoordinates_tilecoordinates">static Double west(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Calculates longitude for west edge of given tile.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of tile in degrees.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Double)</p>
</div>
<div class="paragraph">
<p>Longitude value of west edge of given tile.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-27]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_inmemory_inmemorytileimagerepository">com.tomtom.puas.sip.components.cache.inmemory.InMemoryTileImageRepository</h5>

</div>
<div class="sect4">
<h5 id="_monoresource_gettilecoordinates_coordinates_string_format_string_mapprovider">Mono&lt;Resource&gt; get(TileCoordinates coordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves satellite image tile from in-memory cache.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - of tile to get</p>
</li>
<li>
<p>format (String) - image format of tile file</p>
</li>
<li>
<p>mapProvider (String) - map provider that should be used (e.g.: google)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Resource&gt;)</p>
</div>
<div class="paragraph">
<p>Resource that contains tile image. Returns empty <em>Mono</em> when no tile is found in cache under given key.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-28]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_puttilecoordinates_coordinates_string_format_string_mapprovider_resource_resource_duration_ttl">Mono&lt;Void&gt; put(TileCoordinates coordinates, String format, String mapProvider, Resource resource, Duration ttl)</h5>
<div class="paragraph">
<p>Updates satellite image tile in in-memory cache. If tile does not exist, creates new one.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - of tile to get</p>
</li>
<li>
<p>format (String) - image format of tile file</p>
</li>
<li>
<p>mapProvider (String) - map provider that was used to get given tile</p>
</li>
<li>
<p>resource (Resource) - represents tile to store</p>
</li>
<li>
<p>ttl (Duration) - time-to-live value for given image (might be ignored by cache implementation)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em>. If 'put' operation throws <em>Exception</em>, then <em>Mono</em> with error is returned.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-29]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_inmemory_inmemorytilemetadatarepository">com.tomtom.puas.sip.components.cache.inmemory.InMemoryTileMetadataRepository</h5>

</div>
<div class="sect4">
<h5 id="_monotilemetadata_gettilecoordinates_tilecoordinates_string_format_string_mapprovider">Mono&lt;TileMetadata&gt; get(TileCoordinates tileCoordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves metadata for tile that matches given criteria from in-memory cache.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - of tile metadata to get</p>
</li>
<li>
<p>format (String) - image format of tile metadata file</p>
</li>
<li>
<p>mapProvider (String) - map provider that should be used (e.g.: google)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;TileMetadata&gt;)</p>
</div>
<div class="paragraph">
<p>Round metadata or empty <em>Mono</em> if tile for given criteria does not exist.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-30]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_puttilemetadata_tilemetadata">Mono&lt;Void&gt; put(TileMetadata tileMetadata)</h5>
<div class="paragraph">
<p>Updated metadata for tile that matches given criteria in in-memory cache. Creates new entry if none data exists.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileMetadata (TileMetadata) - metadata object to update in cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-31]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_redis_redistileimagerepository">com.tomtom.puas.sip.components.cache.redis.RedisTileImageRepository</h5>

</div>
<div class="sect4">
<h5 id="_monoresource_gettilecoordinates_coordinates_string_format_string_mapprovider_2">Mono&lt;Resource&gt; get(TileCoordinates coordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves satellite image tile from 2nd level cache. Method doesn&#8217;t throw exception on cache operation error, logs error message instead.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - coordinates of tile to retrieve.</p>
</li>
<li>
<p>format (String) - image format of tile file</p>
</li>
<li>
<p>mapProvider (String) - map provider that should be used (e.g.: google)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Resource&gt;)</p>
</div>
<div class="paragraph">
<p>Resource that contains tile image. Returns empty <em>Mono</em> if no tile was found in cache or exception was thrown during cache operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-32]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_puttilecoordinates_coordinates_string_format_string_mapprovider_resource_resource_duration_ttl_2">Mono&lt;Void&gt; put(TileCoordinates coordinates, String format, String mapProvider, Resource resource, Duration ttl)</h5>
<div class="paragraph">
<p>Updates satellite image tile in 2nd level cache. If tile does not exist, creates new one. Method doesn&#8217;t throw exception on cache operation error, logs error message instead.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - coordinates of tile.</p>
</li>
<li>
<p>format (String) - image format of tile file.</p>
</li>
<li>
<p>mapProvider (String) - map provider that was used to get given tile.</p>
</li>
<li>
<p>resource (Resource) - represents tile to store.</p>
</li>
<li>
<p>ttl (Duration) - time-to-live defines how cache record will be valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em> or exception was thrown during cache operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-33]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_redis_redistilemetadatarepository">com.tomtom.puas.sip.components.cache.redis.RedisTileMetadataRepository</h5>

</div>
<div class="sect4">
<h5 id="_monotilemetadata_gettilecoordinates_tilecoordinates_string_format_string_mapprovider_2">Mono&lt;TileMetadata&gt; get(TileCoordinates tileCoordinates, String format, String mapProvider)</h5>
<div class="paragraph">
<p>Retrieves metadata for tile that matches given criteria from 2nd level cache. Method doesn&#8217;t throw exception on cache operation error, logs error message instead.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinates (TileCoordinates) - of tile metadata.</p>
</li>
<li>
<p>format (String) - image format of tile metadata file.</p>
</li>
<li>
<p>mapProvider (String) - map provider that should be used (e.g.: google).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;TileMetadata&gt;)</p>
</div>
<div class="paragraph">
<p>Round metadata .Returns empty <em>Mono</em> if tile for given criteria does not exist or exception was thrown during cache operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-34]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_puttilemetadata_tilemetadata_2">Mono&lt;Void&gt; put(TileMetadata tileMetadata)</h5>
<div class="paragraph">
<p>Updated metadata for tile that matches given criteria in 2nd level cache. Create new entry if no record under given key exists in cache. Method doesn&#8217;t throw exception on cache operation error, logs error message instead.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileMetadata (TileMetadata) - metadata object to store or update in cache.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em> or exception was thrown during cache operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-35]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_service_impl_defaultnotileareaservice">com.tomtom.puas.sip.components.google.service.impl.DefaultNoTileAreaService</h5>
<div class="paragraph">
<p>Sip service is collection information about areas of the world which don&#8217;t have Google tile for a given zoom - no-tile area.
When tile for such area is requested by the client, Sip stores information about the missing tile in cache. Cache entry contains information about position of the area and max available zoom for it.
More information about no-tile areas can be found <a href="https://confluence.tomtomgroup.com/x/ccVKN">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_cachenotileareatilecoordinates_tilecoordinates_string_format">Mono&lt;Void&gt; cacheNoTileArea(TileCoordinates tileCoordinates, String format)</h5>
<div class="paragraph">
<p>Method stores information about no-tile area in cache for given coordinates and image format. Sip also searches for other no-tile areas around the given coordinates and store them as well.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of area without tile.</p>
</li>
<li>
<p>format (String) - format of tile image.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-36]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monointeger_getmaxsupportedzoomtilecoordinates_tilecoordinates">Mono&lt;Integer&gt; getMaxSupportedZoom(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Method finds and returns the highest available zoom value for given coordinates.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of area without tile.</p>
</li>
<li>
<p>format (String) - format of tile image.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Integer&gt;)</p>
</div>
<div class="paragraph">
<p><em>Mono</em> with the highest available zoom value for given tile coordinates.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-71]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_redis_redisnotilearearepository">com.tomtom.puas.sip.components.cache.redis.RedisNoTileAreaRepository</h5>

</div>
<div class="sect4">
<h5 id="_monovoid_createtilecoordinates_northwest_tilecoordinates_southeast_long_ttl">Mono&lt;Void&gt; create(TileCoordinates northWest, TileCoordinates southEast, long ttl)</h5>
<div class="paragraph">
<p>Stores entry for new no tile area using coordinates as cache key. No-tile area is spread over more than one tile. The entire to-tile region is described with coordinates of corner tiles of the region.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>northWest (TileCoordinates) - coordinates that describes north-west corner point of no-tile rectangle.</p>
</li>
<li>
<p>southEast (TileCoordinates) - coordinates that describes south-east corner point of no-tile rectangle.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em> or <em>Mono</em> error if exception was thrown on Redis operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-38]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monointeger_findminnotsupportedzoomtilecoordinates_tilecoordinates">Mono&lt;Integer&gt; findMinNotSupportedZoom(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Gets the value of zoom for area with the lowest zoom that contains given coordinates. No-tile areas are caches only for certain range of supported zoom values. The range starts with <em>min_supported_zoom</em> value defined in application config.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - coordinates of a tile.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Integer&gt;)</p>
</div>
<div class="paragraph">
<p>Returns minimal zoom value for given coordinates.
Returns empty <em>Mono</em> if:
- no no-tile area found in cache,
- requested zoom is lower than <em>min_supported_zoom</em>,
- requested no-tile area coordinates are expired in cache,
Returns <em>Mono</em> error if exception is thrown during Redis operation.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-39]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_boolean_active">boolean active()</h5>
<div class="paragraph">
<p>Checks if <em>CircuitBreaker</em> is opened.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong></p>
</div>
<div class="paragraph">
<p>'true' if <em>CircuitBreaker</em> is opened, 'false' otherwise.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-72]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_monitoring_tracingidfilter">com.tomtom.puas.sip.monitoring.TracingIdFilter</h5>

</div>
<div class="sect4">
<h5 id="_monovoid_filterserverwebexchange_ex_webfilterchain_chain">Mono&lt;Void&gt; filter(ServerWebExchange ex, WebFilterChain chain)</h5>
<div class="paragraph">
<p>Process the Web request and (optionally) delegate to the next <em>WebFilter</em> through the given <em>WebFilterChain</em>. Method adds 'traceId' key <em>ex</em> object if 'x-b3-traceid' was provided in it.
If 'x-b3-traceid' header is not in request, then <em>ex</em> remains unchanged.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>ex (WebFilter) - the current server exchange object - context of incoming requests.</p>
</li>
<li>
<p>chain (WebFilter) - provides a way to delegate to the next filter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>To indicate when request processing is complete. Method returns when filter chain is completed.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-40]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_utils_exceptionutils">com.tomtom.puas.sip.components.google.utils.ExceptionUtils</h5>

</div>
<div class="sect4">
<h5 id="_static_string_masksensitivestring_msg">static String maskSensitive(String msg)</h5>
<div class="paragraph">
<p>Hides sensitive information in message by replacing then with '<strong><strong>'. Method looks for strings starting with: ["session=", "key="] and ending with: [";|&amp;| |session=|key=|$|\n"].
Everything between start and end strings is replaced with '</strong></strong>'.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>msg (String) - string with potentially sensitive information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (String)</p>
</div>
<div class="paragraph">
<p>String with sensitive information replaced with '<strong>*</strong>'.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-68]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_string_getmessageandstacktracethrowable_e">static String getMessageAndStacktrace(Throwable e)</h5>
<div class="paragraph">
<p>Converts exception to a single string out of exception message and exception stacktrace. Method uses <em>maskSensitive()</em> to hide sensitive information in entire composed string.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>e (Throwable) - exception to be converted into single string message.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (String)</p>
</div>
<div class="paragraph">
<p>String composed of exception message and exception stacktrace.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-69]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_runtimeexception_getsipexceptionwebclientresponseexception_notfound_exception_int_requestedzoom_int_maxzoom">static RuntimeException getSipException(WebClientResponseException.NotFound exception, int requestedZoom, int maxZoom)</h5>
<div class="paragraph">
<p>Maps input <em>exception</em> parameter to <em>RuntimeException</em>.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>exception (WebClientResponseException.NotFound) - exception to map.</p>
</li>
<li>
<p>requestedZoom (int) - zoom value.</p>
</li>
<li>
<p>maxZoom (int) - zoom value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (RuntimeException)</p>
</div>
<div class="paragraph">
<p>If <em>requestedZoom</em> &gt; <em>maxZoom</em>, then return <em>ZoomOutOfRangeException</em>.
Otherwise, call <em>getSipException(WebClientResponseException exception)</em> and return result.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-77]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_sipexception_getsipexceptionwebclientresponseexception_exception">static SipException getSipException(WebClientResponseException exception)</h5>
<div class="paragraph">
<p>Handles exceptions thrown by rest client during calls to external services like Google Api.
It takes <em>WebClientResponseException</em> exceptions and maps it into custom Sip application exception. <em>WebClientResponseException</em> contains fields like response body and error reason which are used for mapping.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>exception (WebClientResponseException) - exception to map.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (SipException)</p>
</div>
<div class="paragraph">
<p>Sip custom exception mapped from input exception according to below table. Custom exception has error code and message set based on input exception.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Input exception reason</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>SipException</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>statusCode</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>errorCode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notFound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvalidParamsException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30003</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notFound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvalidParamsException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30003</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryLaterException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40001</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryLaterException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40004</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quotaExceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryLaterException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40005</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rateLimitExceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryLaterException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40006</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authTokenExpired</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryLaterException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40003</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalidCredentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvalidCredentialsException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40002</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown or non reason / missing response body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UnknownErrorResponseException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30005</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p>UnknownErrorResponseException when response body has incorrect format. Format must match mapping class <em>com.tomtom.puas.sip.components.google.model.ErrorResponse</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-41]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_boolean_issessioninvalidorexpiredexceptionwebclientresponseexception_exception">static boolean isSessionInvalidOrExpiredException(WebClientResponseException exception)</h5>
<div class="paragraph">
<p>Checks reason of input <em>exception</em>.</p>
</div>
<div class="paragraph">
<p><strong>Parameter</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>exception (WebClientResponseException) - exception to check.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (boolean)</p>
</div>
<div class="paragraph">
<p>'true' if reason of exception is 'authTokenExpired' or 'invalidCredentials'. 'false' otherwise.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-76]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_void_logexceptioninfothrowable_e_logger_log">static void logExceptionInfo(Throwable e, Logger log)</h5>
<div class="paragraph">
<p>Prevent logging exceptions of types: <em>RedisConnectionFailureException</em>, <em>CallNotPermittedException</em>, <em>RedisCommandTimeoutException</em>. Logs every other exception.</p>
</div>
<div class="paragraph">
<p><strong>Parameter</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>e (Throwable) - exception to log.</p>
</li>
<li>
<p>log (Logger) - logger.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (void)</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-74]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_runtimeexception_googleunreachableexception">static RuntimeException googleUnreachableException()</h5>
<div class="paragraph">
<p><strong>Returns</strong> (RetryLaterException)</p>
</div>
<div class="paragraph">
<p>Returns <em>RetryLaterException</em> with statusCode=429 and errorCode=50001</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-75]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_model_cachecontroldetails">com.tomtom.puas.sip.model.CacheControlDetails</h5>
<div class="paragraph">
<p>Class holds information about tile cache entry, e.g. expiration date. It is a part as TileMetadata object which defines.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cachecontrol_tocachecontrol">CacheControl toCacheControl()</h5>
<div class="paragraph">
<p>Create new <em>CacheControl</em> object from current <em>CacheControlDetails</em> instance. <em>CacheControl</em> holds information about tile cache entry which are added to response header.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (CacheControl)
New <em>CacheControl</em> instance.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-44]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_duration_getttl">Duration getTtl()</h5>
<div class="paragraph">
<p>Checks time between <em>now</em> and expiration time of <em>CacheControlDetails</em> instance.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Duration)
Time between <em>now</em> and expiration time of <em>CacheControlDetails</em> instance.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-45]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_static_cachecontroldetails_ofresponseentity_response">static CacheControlDetails of(ResponseEntity&lt;?&gt; response)</h5>
<div class="paragraph">
<p>Creates new instance of <em>CacheControlDetails</em> from input <em>ResponseEntity</em>.
<em>CacheControlDetails</em> defines expiration date property which is calculated based on:
- First 'max-age' header value,
- If 'max-age' is not present, then 'Expires' value is used.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>response (ResponseEntity) - input for <em>CacheControlDetails</em> instance creation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (CacheControlDetails)</p>
</div>
<div class="paragraph">
<p>New instance of <em>CacheControlDetails</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-46]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_model_notileareacoordinates">com.tomtom.puas.sip.model.NoTileAreaCoordinates</h5>

</div>
<div class="sect4">
<h5 id="_static_notileareacoordinates_oftilecoordinates_northwestcoordinates_tilecoordinates_southeastcoordinates">static NoTileAreaCoordinates of(TileCoordinates northWestCoordinates, TileCoordinates southEastCoordinates)</h5>
<div class="paragraph">
<p>Creates new instance of <em>NoTileAreaCoordinates</em> class from given coordinates.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>northWestCoordinates (TileCoordinates) - input coordinates for <em>NoTileAreaCoordinates</em> instance creation.</p>
</li>
<li>
<p>southEastCoordinates (TileCoordinates) - input coordinates for <em>NoTileAreaCoordinates</em> instance creation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (NoTileAreaCoordinates)</p>
</div>
<div class="paragraph">
<p>New instance of <em>NoTileAreaCoordinates</em> class.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>IllegalArgumentException</em> when zooms of northWestCoordinates and southEastCoordinates are not equal.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-47]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_boolean_containstilecoordinates_tilecoordinates">boolean contains(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Check if no-tile area contains given tile coordinate. Method gets central point of <em>tileCoordinates</em> parameter and checks if this point is located within rectangle of current no-tile area.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tile coordinates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (boolean)</p>
</div>
<div class="paragraph">
<p>'true' if no-tile area contains given tile coordinate, 'false' otherwise.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-73]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_inmemory_inmemorynotilearearepository">com.tomtom.puas.sip.components.cache.inmemory.InMemoryNoTileAreaRepository</h5>

</div>
<div class="sect4">
<h5 id="_monovoid_createtilecoordinates_northwest_tilecoordinates_southeast_long_ttl_2">Mono&lt;Void&gt; create(TileCoordinates northWest, TileCoordinates southEast, long ttl)</h5>
<div class="paragraph">
<p>Stores entry for new no tile area using coordinates as cache key.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>northWest (TileCoordinates) - coordinates that describes north-west corner point of no-tile area rectangle.</p>
</li>
<li>
<p>southEast (TileCoordinates) - coordinates that describes south-east corner point of no-tile area rectangle.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Void&gt;)</p>
</div>
<div class="paragraph">
<p>Empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-49]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monointeger_findminnotsupportedzoomtilecoordinates_tilecoordinates_2">Mono&lt;Integer&gt; findMinNotSupportedZoom(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Finds lowest not supported zoom for given tile coordinates. Minimal not supported zoom is the lowest zoom value stored in to-tile cache for given coordinates.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tiles coordinates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Integer&gt;)</p>
</div>
<div class="paragraph">
<p>Min zoom value stored in to-tile cache for given coordinates. Empty <em>Mono</em> there are no cache entry for given coordinates.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-50]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_service_impl_defaultgooglemapstileservice">com.tomtom.puas.sip.components.google.service.impl.DefaultGoogleMapsTileService</h5>

</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettiletilecoordinates_tilecoordinates_string_ifnonematch_sessionkey_sessionkey">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(TileCoordinates tileCoordinates, String ifNoneMatch,  SessionKey sessionKey)</h5>
<div class="paragraph">
<p>Retrieves tile image by calling google api over http request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/DefaultGoogleMapsTileService_getTile.svg" alt="DefaultGoogleMapsTileService getTile">
</div>
</div>
<div class="paragraph">
<p><em>DefaultGoogleMapsTileService.getTile - Get tile from google api</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tiles coordinates.</p>
</li>
<li>
<p>String ifNoneMatch - value for request header 'If-None-Match'. It is used to check if requested data was already downloaded.
If it is set and equal value in google api, then google sends '304 - not modified' status code in response.</p>
</li>
<li>
<p>SessionKey sessionKey - api key used to authorize google requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Tile image is returned resource when google api call finished successfully.
Successful http response should contain values like:
    - StatusCode = 'OK',<br>
    - Body = Image Bytes,<br>
    - Header - ContentType = 'image/jpeg',<br>
    - Header - ETag = valid etag value, the same as <em>ifNoneMatch</em>.+
Error <em>Mono</em> is returned when google api returns error response. Response contains then <em>WebClientResponseException</em> exception.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-51]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoboolean_tileexiststilecoordinates_tilecoordinates_sessionkey_sessionkey">Mono&lt;Boolean&gt; tileExists(TileCoordinates tileCoordinates, SessionKey sessionKey)</h5>
<div class="paragraph">
<p>Checks if tile for given coordinates exist by calling google api over http request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/DefaultGoogleMapsTileService_tileExists.svg" alt="DefaultGoogleMapsTileService tileExists">
</div>
</div>
<div class="paragraph">
<p><em>DefaultGoogleMapsTileService.tileExists</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tiles coordinates.</p>
</li>
<li>
<p>SessionKey sessionKey - api key used to authorize google requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (boolean)</p>
</div>
<div class="paragraph">
<p>'true' if tile with given coordinates is available to download from Google, 'false' otherwise.
This method returns <em>WebClientResponseException</em> when response from google api is different from 'OK' (200) or 'NOT_FOUND' (404).</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-52]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentitysession_createsessionstring_language_string_format">Mono&lt;ResponseEntity&lt;Session&gt;&gt; createSession(String language, String format)</h5>
<div class="paragraph">
<p>Gets new google session by calling google api over http request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/DefaultGoogleMapsTileService_createSession.svg" alt="DefaultGoogleMapsTileService createSession">
</div>
</div>
<div class="paragraph">
<p><em>DefaultGoogleMapsTileService.createSession</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>language (String) - language. It is required by google api to provide.</p>
</li>
<li>
<p>format (String) - image format. It is required by google api to provide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Session&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Session token key. The token is commonly provided by Google with expiry date in response. If expiry date is missing or invalid, Sip adds default one to Session object sets for 14 days.
When error is returned from Google Api, then it is returned to client as was received.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-53]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentityviewportinfo_getviewportinfoviewport_viewport_string_ifnonematch_sessionkey_sessionkey">Mono&lt;ResponseEntity&lt;ViewPortInfo&gt;&gt; getViewPortInfo(ViewPort viewPort, String ifNoneMatch, SessionKey sessionKey)</h5>
<div class="paragraph">
<p>Gets view port information by calling google api over http request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/DefaultGoogleMapsTileService_getViewPortInfo.svg" alt="DefaultGoogleMapsTileService getViewPortInfo">
</div>
</div>
<div class="paragraph">
<p><em>DefaultGoogleMapsTileService.getViewPortInfo</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>viewPort (ViewPort) - object which specifies area for which <em>ViewPortInfo</em> should be downloaded. Object contains: zoom value and north, south, east, west coordinates.</p>
</li>
<li>
<p>String ifNoneMatch - value for request header 'If-None-Match'. It is used to check if requested data was already downloaded.
If it is set and equal value in google api, then google sends '304 - not modified' status code in response.</p>
</li>
<li>
<p>SessionKey sessionKey - api key used to authorize google requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;ViewPortInfo&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>When call is successful, then returns <em>ViewPortInfo</em> which contains copyright for the given area.<br>
Successful http response should contain values like:
- StatusCode = 'OK',<br>
- Body = Image Bytes,<br>
- Header - ContentType = 'image/jpeg',<br>
- Header - ETag = valid etag value, the same as <em>ifNoneMatch</em>.+
Error <em>Mono</em> is returned when google api returns error response. Response contains then <em>WebClientResponseException</em> exception.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-54]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monovoid_fallbackexception_e">Mono&lt;Void&gt; fallback(Exception e)</h5>
<div class="paragraph">
<p>Handles exceptions thrown from methods in <em>DefaultGoogleMapsTileService</em>.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>e (Exception) - thrown exception</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;T&gt;)</p>
</div>
<div class="paragraph">
<p>429 'Too Many Requests' - if CallNotPermittedException or TimeoutException or CancellationException.
For every other type, returns input exception error.
429, Series.CLIENT_ERROR, "Too Many Requests"</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-55]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_void_cleanup_throws_exception">void cleanUp() throws Exception</h5>
<div class="paragraph">
<p>Framework method used to finalizing service instance when server is shutdown.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-61]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_exception_restexceptionhandler">com.tomtom.puas.sip.exception.RestExceptionHandler</h5>

</div>
<div class="sect4">
<h5 id="_monovoid_handleserverwebexchange_exchange_throwable_ex">Mono&lt;Void&gt; handle(ServerWebExchange exchange, Throwable ex)</h5>
<div class="paragraph">
<p>Handles globally exception thrown in application that wasn&#8217;t caught.
Exception are further translated to http response codes according to below table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SipException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error code from SipException (additionally: If <em>ZoomOutOfRangeException</em>, Then Sets "x-max-zoom" header)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServerWebInputException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVALID_REQUEST_FORMAT(40004)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ResponseStatusException</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTERNAL_ERROR(30005)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other exceptions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception from <em>ex</em> param</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Headers set in response:
'Content-Type': 'json'
x-max-zoom: &lt;Integer&gt; (if <em>ZoomOutOfRangeException</em> was thrown)</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>ex (Exception) - input exception.</p>
</li>
<li>
<p>exchange (ServerWebExchange) - object holding response date.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[Req-SIP-56]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_service_impl_defaultmaxzoomservice">com.tomtom.puas.sip.components.google.service.impl.DefaultMaxZoomService</h5>

</div>
<div class="sect4">
<h5 id="_monointeger_getmaxsupportedzoomtilecoordinates_tilecoordinates_2">Mono&lt;Integer&gt; getMaxSupportedZoom(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Finds in max-zoom cache and return maximum zoom value supported for given coordinates.
Max zooms are cached in json files stored in Azure blob storage. The cache contains collection of file prefixed with <em>maxzoomrects</em>. Each file contains zooms for different part of the world.
At method at beginning downloads cache files from azure with 1 retry if download fails. It looks for files in configured directory with specified prefix. If directory contains other files, they will be ignored.
Each file contains list of entries like example below:<br>
{"z": 20, "n": 32.310791, "s": 31.98120110000002, "e": 13.084716700000001, "w": 12.919921799999997}<br>
where 'z' is zoom followed by degree coordinates of north, south, east, west edge of the area.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tile coordinates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Integer&gt;)</p>
</div>
<div class="paragraph">
<p>Max supported maximum zoom value supported for given coordinates.
if max supported zoom is larger or equal then given zoom in <em>tileCoordinates</em>, then it returns <em>tileCoordinates.zoom</em>.
If no tiles for given area are present, then returns empty <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-57]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_service_impl_cachingsessioncontextprovider">com.tomtom.puas.sip.components.google.service.impl.CachingSessionContextProvider</h5>

</div>
<div class="sect4">
<h5 id="_sessioncontext_sessioncontextstring_language_string_format">SessionContext sessionContext(String language, String format)</h5>
<div class="paragraph">
<p>Create new <em>SessionContext</em> object. <em>SessionContext</em> contains google session token which can authorize Google Api calls made within this context.
Token is set in context either by retrieving it from cache 1st/2nd level, or by creating new one with Google Api request for new session token.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/CachingSessionContextProvider_sessionContext.svg" alt="CachingSessionContextProvider sessionContext">
</div>
</div>
<div class="paragraph">
<p><em>CachingSessionContextProvider.sessionContext</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>language (String) - language. It is required by google api to provide.</p>
</li>
<li>
<p>format (String) - image format. It is required by google api to provide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (SessionContext)</p>
</div>
<div class="paragraph">
<p>Session token key. The token is commonly provided by Google with expiry date in response. If expiry date is missing or invalid, Sip adds default one to Session object sets for 14 days.</p>
</div>
<div class="paragraph">
<p><strong>Throws</strong></p>
</div>
<div class="paragraph">
<p><em>WebClientResponseException</em> when function executed within session context returned <em>Mono</em> error with one of reasons: "invalidCredentials" or "authTokenExpired".</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-59]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_cache_cronjobs_sessiontokenupdatecronjob">com.tomtom.puas.sip.components.cache.cronjobs.SessionTokenUpdateCronjob</h5>

</div>
<div class="sect4">
<h5 id="_void_updatesessiontokens">void updateSessionTokens()</h5>
<div class="paragraph">
<p>Method is executed periodically and updates google session token saved in 2nd level cache if expiration time is less than given interval.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/cache/SessionTokenUpdateCronjob_updateSessionTokens.svg" alt="SessionTokenUpdateCronjob updateSessionTokens">
</div>
</div>
<div class="paragraph">
<p><em>CachingSessionContextProvider.sessionContext</em></p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-60]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_model_tilecoordinates">com.tomtom.puas.sip.model.TileCoordinates</h5>

</div>
<div class="sect4">
<h5 id="_tilecoordinates_tolowerzoomint_lowerzoom">TileCoordinates toLowerZoom(int lowerZoom)</h5>
<div class="paragraph">
<p>Compares given lower zoom value with the instance zoom and returns the lower one.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>lowerZoom (int) - zoom value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (TileCoordinates)</p>
</div>
<div class="paragraph">
<p>If instance zoom is lower than given, then instance of <em>TileCoordinates</em> is returned unchanged.
if instance zoom is higher than given, then returns new instance on <em>TileCoordinates</em> with <em>lowerZoom</em> value and recalculated coordinates x, y.
Formula to recalculate coordinates: new_coordinate = current_coordinate / 2 ^ (current_zoom - lowerZoom).</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-62]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_google_service_impl_googlesatelliteimageservice">com.tomtom.puas.sip.components.google.service.impl.GoogleSatelliteImageService</h5>

</div>
<div class="sect4">
<h5 id="_monoresponseentitycopyright_getcopyrightviewport_viewport_string_ifnonematch_string_language">Mono&lt;ResponseEntity&lt;Copyright&gt;&gt; getCopyright(ViewPort viewPort, String ifNoneMatch, String language)</h5>
<div class="paragraph">
<p>Gets copyright information for area specified by <em>viewPort</em> parameter.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/GoogleSatelliteImageService_getCopyright.svg" alt="GoogleSatelliteImageService getCopyright"></span>
<em>GoogleSatelliteImageService.getCopyright</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>viewPort - viewport for which copyright should be found.</p>
</li>
<li>
<p>ifNoneMatch - identifier for a specific version of resource. Determines if this resource was already requested by client service.</p>
</li>
<li>
<p>language - language identifier indicating the language information on the tile. If no language is specified, then default (en-US) one will be used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong></p>
</div>
<div class="paragraph">
<p>Response entity that contains copyright information in body or error according to <em>ExceptionUtils.getSipException</em> mapping.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-63]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentitymetadata_getmetadata">Mono&lt;ResponseEntity&lt;Metadata&gt;&gt; getMetadata()</h5>
<div class="paragraph">
<p>Gets metadata information about coordinates system and projection typed used by service. This information has fixed values configured in application configuration.</p>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Metadata&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Metadata information about coordinates system and projection typed used by service.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-64]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monoresponseentityresource_gettiletilecoordinates_tilecoordinates_string_ifnonematch_string_format">Mono&lt;ResponseEntity&lt;Resource&gt;&gt; getTile(TileCoordinates tileCoordinates, String ifNoneMatch, String format)</h5>
<div class="paragraph">
<p>Gets tile from Google Api for given coordinates.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/GoogleSatelliteImageService_getTile.svg" alt="GoogleSatelliteImageService getTile"></span>
<em>GoogleSatelliteImageService.getTile</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates - coordinates which specifies requested tile.</p>
</li>
<li>
<p>ifNoneMatch - identifier for a specific version of resource. Is used by Google Api to verify if requested resource was already downloaded.</p>
</li>
<li>
<p>format - image format of tile file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;ResponseEntity&lt;Resource&gt;&gt;)</p>
</div>
<div class="paragraph">
<p>Tile resource or exception according to <em>ExceptionUtils.getSipException</em> mapping.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-65]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_monointeger_getmaxsupportedzoomtilecoordinates_tilecoordinates_3">Mono&lt;Integer&gt; getMaxSupportedZoom(TileCoordinates tileCoordinates)</h5>
<div class="paragraph">
<p>Gat maximum supported value for given coordinates.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="SatelliteImageProxyServiceDetailedDesign_resources/behaviour_diagrams/google_service/GoogleSatelliteImageService_getMaxSupportedZoom.svg" alt="GoogleSatelliteImageService getMaxSupportedZoom"></span>
<em>GoogleSatelliteImageService.getMaxSupportedZoom</em></p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tileCoordinates (TileCoordinates) - tile coordinates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong> (Mono&lt;Integer&gt;)</p>
</div>
<div class="paragraph">
<p>Maximum supported zoom value.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-66]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_com_tomtom_puas_sip_components_compression_impl_jpegcompressionservice">com.tomtom.puas.sip.components.compression.impl.JpegCompressionService</h5>

</div>
<div class="sect4">
<h5 id="_resource_compressresource_input_int_qualitylevel">Resource compress(Resource input, int qualityLevel);</h5>
<div class="paragraph">
<p>Compresses given resource.</p>
</div>
<div class="paragraph">
<p><strong>Parameters</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>input - resource that should be compressed</p>
</li>
<li>
<p>qualityLevel - a percent indicating the desired quality level</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns</strong></p>
</div>
<div class="paragraph">
<p>Compressed resource. If IOException was thrown during compression returns uncompressed resource.</p>
</div>
<div class="paragraph">
<p><em>[Req-SIP-67]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_glossary">.1.2. Glossary</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is a string which specifies the version of a resource on the Google Api side. It usually refers to tile (satellite image of Earth area) which can change (by updated by Google) over time. Sip service is using etag to verify if has up-to-date version of certain tail and not download the same resource multiple times. Therefor etag is sent between Sip and Google goth ways. If requested tile is up-to-date, then google sent back '302 - Not Modified' response instead of actual resource.<br>
Remark: in the code you can see etag under <em>ifNoneMatch</em> parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zoom&#160;Level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google divides world map to matrix of tiles. Zoom level specifies amount of rows/columns that matrix will have. The highest zoom level is, the more tiles world division will have. Higher zoom level also means smaller and more accurate tiles.<br>
For more information on a tiles and zoom levels go to <a href="https://developers.google.com/maps/documentation/javascript/coordinates#tile-coordinates">Google documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Satellite image of area of Earth. Sip uses <em>jpeg</em> format for the images.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tile Coordinates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of 3 integers (x, y and zoom) that specifies tile location on the map of the world. Google divides world map to matrix of tiles. Zoom level specifies amount of rows/columns that matrix will have. Tile coordinates x, y specifies row and column of the metrics.<br>
For more information on a tiles and zoom levels go to <a href="https://developers.google.com/maps/documentation/javascript/coordinates#tile-coordinates">Google documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">View Port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is a 4 degree coordinate specifying certain area of the world. Position are south (latitude), north (latitude), west (longitude), east (longitude).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Zoom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum zoom level that has satellite tile image available for given area; this value is returned to client in header of HTTP 404 response (see <a href="https://confluence.tomtomgroup.com/x/ccVKN">Max Zoom header in 404 response</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No-Tile Area</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">area that does not contain tiles for given zoom level; areas are calculated preemptively to efficiently respond with most accurate max-zoom value (see No-tile Areas section in <a href="https://confluence.tomtomgroup.com/x/ccVKN">Max Zoom header in 404 response</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quality Level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value defining what should be JPEG quality of returned tiles; if map provider gives greater quality, SIP is re-compressing image to defined value (see <a href="https://confluence.tomtomgroup.com/x/EL5KN">Image Compression - JPEG</a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_behavior">.2. Dynamic Behavior</h3>
<div class="paragraph">
<p>SIP service runs cron job which is independent process from serving responses to the client. Cron job is responsible for refreshing Google session tokens stored in Redis cache. Job runs every 24 hours. For more information see <a href="#google-session-management">Google session management</a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_non_functional_attributes">.3. Non-functional attributes</h3>
<div class="paragraph">
<p><strong>SonarQube and code quality</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coding standard violation analysis is provided with SonarQube. It is integrated to pipeline and run for every merge to master branch.
Results: <a href="https://sonar.ad.tomtomgroup.com/dashboard?id=hcp3-sip">SonarQube</a><br>
<a href="https://jira.tomtomgroup.com/browse/HCP3-1580">HCP3-1580</a> - Software needs to be analyzed for coding standard violations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Following coding guidelines should be followed during development: <a href="https://confluence.tomtomgroup.com/display/NAV/NavKit2+Java+style+guide">Coding Guidelines</a></p>
</div>
<div class="paragraph">
<p><strong>BlackDuck</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security vulnerabilities are provided with <a href="https://hub.tomtomgroup.com/">BlackDuck</a>.
Results:
<a href="https://jira.tomtomgroup.com/browse/HCP3-1579">HCP3-1579</a> - Software needs to be analysed for security vulnerabilities</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>KPI</strong></p>
</div>
<div class="paragraph">
<p>Please see <a href="https://confluence.tomtomgroup.com/x/u0zjMg">Services KPIs</a> and <a href="https://confluence.tomtomgroup.com/x/716bMQ">Product KPIs</a> pages for other non-functional requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling">.4. Error handling</h3>
<div class="paragraph">
<p>When SIP encounter error during request processing, it returns proper response to the client. Error response contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http status according http protocol specification to  e.g.: "404 Not Found"</p>
</li>
<li>
<p>response body, which contains: "errorCode" and "message", e.g.:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
    "errorCode":30003,
    "message":"invalid - Invalid Value"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>errorCode</em> is set by SIP to specify root cause of error situation. See table below for mapping between http statuses and SIP status codes.<br>
<em>message</em> is a short text description of root cause.</p>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_handling_errors_from_google">.4.1. Handling errors from google</h4>
<div class="paragraph">
<p>Based on errors defined in the <a href="https://developers.google.com/maps/documentation/tile#error_reasons">Google tile documentation</a></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Error response from google</th>
<th class="tableblock halign-left valign-top">Action taken / SIP Response</th>
<th class="tableblock halign-left valign-top">Error code</th>
<th class="tableblock halign-left valign-top">Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any other undocumented errors or invalid data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500 (internal server error)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30005</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authTokenExpired: Your session token has expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">retry once with a newly created session.</p>
<p class="tableblock">if even that fails, then 429 (RetryLater)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AuthToken Expired: 40003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We cache the sessions and evict them based on their expiry time.</p>
<p class="tableblock">So we should not get this error. But in case we get it, we create a new session and try again (once).</p>
<p class="tableblock">But if even the retry fails, then this could be a temporary issue in the Google server, so return 429.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection/read timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429 (RetryLater)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google API is unreachable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid: this is not documented in google tile documentation. but during testing, observed that we get this error reason when providing out of range x, y, or invalid format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">404 (not found)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30003</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalidCredentials: The session URL parameter is not a valid value. Generate new session</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500 (internal server error)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Credentials: 40002</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notFound: Your x, y, or z values are out of range:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">404 (not found)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30003</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quotaExceeded and rateLimitExceeded: Your application has exceeded its allowed quota or queries per second.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429 (RetryLater)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quota Exceeded:  40005
RateLimit Exceeded: 40006</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>required:</strong> Your request is missing a URL parameter.</p>
<p class="tableblock"><strong>badRequest:</strong> Your request was not formed correctly.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429 (RetryLater)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Request: 40004</p>
<p class="tableblock">BadRequest: 40001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We don&#8217;t add/remove url parameters on the fly.</p>
<p class="tableblock">We have a fixed url template with typed parameters. So no chance of invalid data types.</p>
<p class="tableblock">Once we have it working (which we already have), we should never get this error. If at all we get this, then this could be a temporary issue in the Google server. So return 429.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If we respond with a 429/500, then further requests should be limited using a circuit breaker with exponential backoff (yet to be implemented)
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Right now, specific error codes are returned from sip to api client. Although it doesn&#8217;t bring anything to the client, we are going to use this specific error codes and messages for debugging purposes.General
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_error_codes_mapping">.4.2. Error Codes mapping</h4>
<div class="paragraph">
<p>Http error codes are more general than SIP statuses, that&#8217;s why single http status match multiple SIP error codes. Below table presents this relation.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP Status</th>
<th class="tableblock halign-left valign-top">Error code</th>
<th class="tableblock halign-left valign-top">Reasoning / Possible cause</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="7"><p class="tableblock">404 (Not Found)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format not supported (Any other format than Jpeg is not supported)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Compression Factor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Compression Factor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Values out of range (ex: zoom/x-coord/y-coord )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Region not Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30006</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40007</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsupported image format received from tile provider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400 (BadRequest)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">* malformed syntax</p>
<p class="tableblock">* the incorrect type of parameter (in a header, path, or body)</p>
<p class="tableblock">* missing mandatory query parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">500 (internal server error)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Credentials</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30005</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error from Google: Unknown or non reason / missing response body</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">429 (RetryLater)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google API is unreachable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40005</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quota Exceeded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40006</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RateLimit Exceeded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BadRequest</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verification_and_validation">1. Verification and validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special verification and validation requirements apply to this service.</p>
</div>
<div class="paragraph">
<p>Please refer to top level Test section</p>
</div>
<div class="sect2">
<h3 id="_unit_tests">1.1. Unit tests</h3>
<div class="paragraph">
<p><a href="https://github.com/tomtom-internal/hcp3-sip/tree/master/src/test/java/com/tomtom/puas/sip" class="bare">https://github.com/tomtom-internal/hcp3-sip/tree/master/src/test/java/com/tomtom/puas/sip</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_integration_and_qualification_tests_xray">1.2. Integration and qualification tests (Xray)</h3>
<div class="paragraph">
<p><a href="https://jira.tomtomgroup.com/issues/?jql=project%20%3D%20HCP3%20AND%20issuetype%20%3D%20Test%20AND%20key%20in%20linkedIssues(%22HCP3-89%22)%20and%20%22Test%20Level%22%20%3D%20%22Integration%20Test%22">Integration tests JIRA</a></p>
</div>
<div class="paragraph">
<p><a href="https://jira.tomtomgroup.com/issues/?jql=project%20%3D%20HCP3%20AND%20issuetype%20%3D%20Test%20AND%20key%20in%20linkedIssues(%22HCP3-89%22)%20and%20%22Test%20Level%22%20%3D%20%22Qualification%20test%22">Qualification tests JIRA</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_running_automated_tests">1.3. Running automated tests</h3>
<div class="paragraph">
<p>Test environment setup and testing procedure is described in <a href="https://github.com/tomtom-internal/hcp3-sip/blob/master/tests/README.md">README file in the source code repository</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terminology_and_abbreviations">2. Terminology and abbreviations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>max-zoom - maximum zoom level that has satellite tile image available for given area; this value is returned to client in header of HTTP 404 response (see <a href="https://confluence.tomtomgroup.com/x/ccVKN">Max Zoom header in 404 response</a>)</p>
</li>
<li>
<p>no-tile-area - area that does not contain tiles for given zoom level; areas are calculated preemptively to efficiently respond with most accurate max-zoom value (see No-tile Areas section in <a href="#https://confluence.tomtomgroup.com/x/ccVKN">Max Zoom header in 404 response</a>)</p>
</li>
<li>
<p>quality level - value defining what should be JPEG quality of returned tiles; if map provider gives greater quality, SIP is re-compressing image to defined value (see <a href="https://confluence.tomtomgroup.com/x/EL5KN">Image Compression - JPEG</a>)</p>
</li>
<li>
<p>SIP - Satellite Image Proxy</p>
</li>
<li>
<p>tile - a single satellite map image</p>
</li>
<li>
<p>tile coordinates - set of 3 integers (x, y and zoom) that describes tile location on the map of the world; more info can be found in <a href="https://developers.google.com/maps/documentation/javascript/coordinates#tile-coordinates">Google API documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">3. References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Maps Tile API <a href="https://developers.google.com/maps/documentation/tile" class="bare">https://developers.google.com/maps/documentation/tile</a></p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-25 14:11:10 +0200
</div>
</div>
</body>
</html>